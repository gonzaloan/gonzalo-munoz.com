<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Welcome Back!</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles.css">
    <style>
        .user-info-panel {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 4px solid #fff;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100;
            max-width: 500px;
            width: 90%;
            color: white;
            font-family: 'Press Start 2P', cursive, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
        }

        .user-info-panel h2 {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .info-section {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 12px;
        }

        .info-label {
            font-weight: bold;
            color: #FFD700;
        }

        .info-value {
            color: #fff;
            text-align: right;
        }

        .api-status {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 12px;
        }

        .api-status.connected {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }

        .api-status.loading {
            background: rgba(255, 193, 7, 0.3);
            border: 2px solid #FFC107;
        }

        .api-status.error {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }

        .logout-btn {
            width: 100%;
            margin-top: 20px;
        }

        .star-icon {
            display: inline-block;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            text-align: center;
            color: white;
        }

        .loading-spinner h2 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        #error-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .error-content {
            max-width: 500px;
        }

        .error-content h2 {
            color: #f44336;
            font-size: 24px;
            margin-bottom: 20px;
        }

        /* Header user info */
        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .user-info-text {
            color: white;
            font-size: 14px;
            font-family: 'Press Start 2P', cursive;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .user-info-text strong {
            color: #FFD700;
        }

        #logout-button-header {
            margin-left: 10px;
        }

        /* Interactive Boxes */
        .interactive-boxes {
            position: absolute;
            top: 200px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            z-index: 10;
        }

        /* Welcome Message */
        .welcome-message {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Press Start 2P', cursive;
            font-size: 20px;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            z-index: 10;
            animation: bounce 2s infinite;
            text-align: center;
        }

        .welcome-message .verified-badge {
            display: inline-block;
            margin-left: 10px;
            font-size: 16px;
        }

        .info-box {
            width: 120px;
            height: 120px;
            background: linear-gradient(145deg, #FFD700, #FFA500);
            border: 4px solid #fff;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4), inset 0 -4px 0 rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .info-box.active:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.5), inset 0 -4px 0 rgba(0,0,0,0.3);
            background: linear-gradient(145deg, #FFE55C, #FFB84D);
        }

        .info-box.active:active {
            transform: translateY(-5px) scale(0.95);
        }

        .info-box.disabled {
            background: linear-gradient(145deg, #888, #666);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .info-box.disabled:hover {
            transform: none;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4), inset 0 -4px 0 rgba(0,0,0,0.2);
        }

        .box-icon {
            font-size: 64px;
            font-family: 'Press Start 2P', cursive;
            font-weight: bold;
            color: #fff;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            margin-bottom: 8px;
            line-height: 1;
        }

        .box-label {
            font-size: 10px;
            font-family: 'Press Start 2P', cursive;
            color: #333;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
            text-align: center;
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        /* Mario-style Pop-up */
        .info-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .popup-content {
            background: linear-gradient(135deg, #1E88E5 0%, #1565C0 100%);
            border: 6px solid #fff;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 500px;
            width: 90%;
            padding: 0;
            overflow: hidden;
            animation: popIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .popup-header {
            background: #FFD700;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid #FFA500;
        }

        .popup-header h3 {
            margin: 0;
            font-family: 'Press Start 2P', cursive;
            font-size: 18px;
            color: #333;
            text-shadow: 2px 2px 0 rgba(255,255,255,0.5);
        }

        .popup-close {
            background: #f44336;
            border: 3px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .popup-close:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .popup-body {
            padding: 30px;
            color: white;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            line-height: 1.8;
            min-height: 100px;
        }

        .popup-footer {
            padding: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            background: rgba(0,0,0,0.2);
        }

        .popup-footer .snes-button {
            flex: 1;
            max-width: 150px;
        }

        @media (max-width: 1024px) {
            .welcome-message {
                font-size: 16px;
                top: 110px;
            }

            .interactive-boxes {
                gap: 20px;
                top: 180px;
            }

            .info-box {
                width: 100px;
                height: 100px;
            }

            .box-icon {
                font-size: 54px;
            }

            .box-label {
                font-size: 9px;
                bottom: -20px;
            }
        }

        @media (max-width: 768px) {
            .welcome-message {
                font-size: 14px;
                top: 100px;
                max-width: 90%;
            }

            .interactive-boxes {
                flex-wrap: wrap;
                gap: 15px;
                top: 150px;
                max-width: 95%;
                justify-content: center;
            }

            .info-box {
                width: 90px;
                height: 90px;
            }

            .box-icon {
                font-size: 48px;
            }

            .box-label {
                font-size: 8px;
                bottom: -20px;
            }

            .user-info-text {
                font-size: 10px;
            }

            .header-center {
                display: none !important;
            }

            .popup-content {
                width: 95%;
                margin: 10px;
            }

            .popup-header h3 {
                font-size: 14px;
            }

            .popup-body {
                font-size: 12px;
                padding: 20px;
            }

            .popup-footer .snes-button {
                font-size: 12px;
                padding: 10px 15px;
            }
        }

        @media (max-width: 480px) {
            .welcome-message {
                font-size: 10px;
                top: 90px;
                padding: 0 10px;
            }

            .welcome-message .verified-badge {
                font-size: 12px;
            }

            .interactive-boxes {
                top: 130px;
                gap: 10px;
            }

            .info-box {
                width: 70px;
                height: 70px;
            }

            .box-icon {
                font-size: 38px;
                margin-bottom: 4px;
            }

            .box-label {
                font-size: 7px;
                bottom: -18px;
            }

            .user-info-text {
                font-size: 8px;
            }

            .popup-header h3 {
                font-size: 12px;
            }

            .popup-body {
                font-size: 10px;
                padding: 15px;
                line-height: 1.6;
            }

            .popup-footer {
                flex-direction: column;
                gap: 10px;
            }

            .popup-footer .snes-button {
                max-width: 100%;
                font-size: 11px;
            }

            .popup-close {
                width: 35px;
                height: 35px;
                font-size: 20px;
            }

            .header-left img {
                max-width: 80px;
            }
        }

        @media (max-width: 360px) {
            .welcome-message {
                font-size: 9px;
                top: 85px;
            }

            .interactive-boxes {
                top: 120px;
                gap: 8px;
            }

            .info-box {
                width: 60px;
                height: 60px;
            }

            .box-icon {
                font-size: 32px;
            }

            .box-label {
                font-size: 6px;
                bottom: -15px;
            }
        }
    </style>
</head>
<body>
<!-- Loading Container -->
<div id="loading-container" style="display: none;">
    <div class="loading-spinner">
        <div class="loading-logo">
            <div class="mario-jump"></div>
        </div>
        <h2>Authenticating...</h2>
        <p>Please wait while we verify your credentials.</p>
    </div>
</div>

<!-- Error Container -->
<div id="error-container" style="display: none;">
    <div class="error-content">
        <h2>Authentication Error</h2>
        <p id="error-message">Something went wrong. Please try again.</p>
        <button onclick="window.location.href='index.html'" class="snes-button" style="margin-top: 20px;">Back to Home</button>
    </div>
</div>

<!-- Main Game Container -->
<header class="game-header">
    <div class="header-content">
        <div class="header-left">
            <img src="./img/logo.png" alt="Logo" class="header-logo">
        </div>
        <div class="header-center" id="user-info-header" style="display: none;">
            <span class="user-info-text">
                <strong>Welcome Back!</strong>
                <span id="header-email">Loading...</span> |
                <span id="header-username">Loading...</span>
            </span>
        </div>
        <div class="header-right">
            <a href="https://guide.gonzalo-munoz.com" class="snes-button" target="_blank">My Notes!</a>
            <button id="logout-button-header" class="snes-button" style="display: none;">Logout</button>
        </div>
    </div>
</header>

<div id="game-container">
    <div id="mario"></div>
    <div class="coins">
        <div class="coin-icon"></div>
        <span id="coin-count">99</span>
    </div>

    <!-- Welcome Message -->
    <div class="welcome-message" id="welcome-message" style="display: none;">
        Welcome Back!
        <span class="verified-badge" id="verified-badge"></span>
    </div>

    <!-- Interactive Boxes -->
    <div class="interactive-boxes">
        <div class="info-box disabled">
            <div class="box-icon">?</div>
            <span class="box-label"></span>
        </div>
        <div class="info-box disabled">
            <div class="box-icon">?</div>
            <span class="box-label"></span>
        </div>
        <div class="info-box active" data-title="Game Analyzer" data-content="Analyze and track your gaming statistics and performance." data-action="#">
            <div class="box-icon">?</div>
            <span class="box-label">game-analyzer</span>
        </div>
        <div class="info-box disabled">
            <div class="box-icon">?</div>
            <span class="box-label"></span>
        </div>
        <div class="info-box disabled">
            <div class="box-icon">?</div>
            <span class="box-label"></span>
        </div>
    </div>

    <!-- Mario-style Pop-up -->
    <div id="info-popup" class="info-popup" style="display: none;">
        <div class="popup-content">
            <div class="popup-header">
                <h3 id="popup-title">Title</h3>
                <button class="popup-close">×</button>
            </div>
            <div class="popup-body">
                <p id="popup-text">Content goes here</p>
            </div>
            <div class="popup-footer">
                <button id="popup-go" class="snes-button">Go</button>
                <button id="popup-cancel" class="snes-button">Cancel</button>
            </div>
        </div>
    </div>

    <div id="mobile-controls">
        <button id="left-arrow">←</button>
        <button id="right-arrow">→</button>
    </div>
</div>

<!-- Audio Elements -->
<audio id="bg-music" loop>
    <source src="./music/mario-ground-theme.mp3" type="audio/mpeg">
</audio>
<audio id="victory-music">
    <source src="./music/mario-castle-complete.mp3" type="audio/mpeg">
</audio>

<script src="auth-config.js"></script>
<script src="api-client.js"></script>
<script src="logged.js"></script>
<script type="module" src="js/main.js"></script>
<script>
    // Handle Cognito callback and exchange code for tokens
    async function handleCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        if (error) {
            showError(`Authentication error: ${error}`);
            return;
        }

        if (!code) {
            // Check if already logged in
            const idToken = sessionStorage.getItem('idToken');
            if (idToken && isTokenValid(idToken)) {
                displayUserInfo();
                return;
            }
            showError('No authentication code found. Please login again.');
            return;
        }

        // Show loading
        document.getElementById('loading-container').style.display = 'flex';

        try {
            // Exchange code for tokens
            const tokens = await exchangeCodeForTokens(code);

            // Store tokens in sessionStorage
            sessionStorage.setItem('idToken', tokens.id_token);
            sessionStorage.setItem('accessToken', tokens.access_token);
            sessionStorage.setItem('refreshToken', tokens.refresh_token);

            // Clean URL (remove code parameter)
            window.history.replaceState({}, document.title, window.location.pathname);

            // Display user info
            displayUserInfo();
        } catch (err) {
            console.error('Token exchange failed:', err);
            showError('Failed to authenticate. Please try again.');
        }
    }

    // Exchange authorization code for tokens
    async function exchangeCodeForTokens(code) {
        const tokenEndpoint = `${COGNITO_CONFIG.domain}/oauth2/token`;

        const params = new URLSearchParams({
            grant_type: 'authorization_code',
            client_id: COGNITO_CONFIG.clientId,
            code: code,
            redirect_uri: getRedirectUri()
        });

        const response = await fetch(tokenEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: params.toString()
        });

        if (!response.ok) {
            throw new Error('Token exchange failed');
        }

        return await response.json();
    }

    // Check if token is valid (not expired)
    function isTokenValid(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const exp = payload.exp * 1000; // Convert to milliseconds
            return Date.now() < exp;
        } catch (e) {
            return false;
        }
    }

    // Decode JWT and get user info from token
    function getUserInfoFromToken(idToken) {
        try {
            const payload = JSON.parse(atob(idToken.split('.')[1]));
            return {
                email: payload.email || payload['cognito:username'] || 'User',
                username: payload['cognito:username'] || payload.email || 'User',
                emailVerified: payload.email_verified || false,
                sub: payload.sub
            };
        } catch (e) {
            return { email: 'User', username: 'User', emailVerified: false };
        }
    }

    // Load user info from API
    async function loadApiUserInfo() {
        const statusDiv = document.getElementById('api-status');

        try {
            const apiUserInfo = await getUserInfo();

            if (apiUserInfo && apiUserInfo.user) {
                statusDiv.className = 'api-status connected';
                statusDiv.innerHTML = '<span>API Connected!</span>';
            } else {
                statusDiv.className = 'api-status error';
                statusDiv.innerHTML = '<span>API responded but no data</span>';
            }
        } catch (error) {
            console.error('Failed to load API user info:', error);
            statusDiv.className = 'api-status error';

            // Show CORS error hint for localhost
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                statusDiv.innerHTML = '<span>CORS: Use production URL</span>';
            } else {
                statusDiv.innerHTML = '<span>API Connection Failed</span>';
            }
        }
    }

    // Display user info
    function displayUserInfo() {
        const idToken = sessionStorage.getItem('idToken');

        if (!idToken) {
            showError('No valid session found. Please login again.');
            return;
        }

        const userInfo = getUserInfoFromToken(idToken);

        document.getElementById('loading-container').style.display = 'none';

        // Update header with user info
        document.getElementById('user-info-header').style.display = 'flex';
        document.getElementById('header-email').textContent = userInfo.email;
        document.getElementById('header-username').textContent = userInfo.username;
        document.getElementById('logout-button-header').style.display = 'inline-block';

        // Show welcome message
        document.getElementById('welcome-message').style.display = 'block';
        const verifiedBadge = document.getElementById('verified-badge');
        verifiedBadge.textContent = userInfo.emailVerified ? '✅' : '⚠️';
        verifiedBadge.title = userInfo.emailVerified ? 'Email Verified' : 'Email Not Verified';

        // Setup logout button
        document.getElementById('logout-button-header').addEventListener('click', logout);

        // Load user info from API
        loadApiUserInfo();

        // Initialize the Logged class for animations
        new Logged();

        // Setup interactive boxes
        setupInteractiveBoxes();
    }

    // Setup interactive boxes
    function setupInteractiveBoxes() {
        const boxes = document.querySelectorAll('.info-box.active');
        const popup = document.getElementById('info-popup');
        const popupTitle = document.getElementById('popup-title');
        const popupText = document.getElementById('popup-text');
        const popupGo = document.getElementById('popup-go');
        const popupCancel = document.getElementById('popup-cancel');
        const popupClose = document.querySelector('.popup-close');

        console.log('Active boxes found:', boxes.length);

        let currentAction = null;

        boxes.forEach((box, index) => {
            console.log('Setting up box', index, box);
            box.addEventListener('click', (e) => {
                console.log('Box clicked!', box);
                e.stopPropagation();

                const title = box.getAttribute('data-title');
                const content = box.getAttribute('data-content');
                const action = box.getAttribute('data-action');

                console.log('Title:', title, 'Content:', content);

                popupTitle.textContent = title;
                popupText.textContent = content;
                currentAction = action;

                popup.style.display = 'flex';
            });
        });

        if (popupGo) {
            popupGo.addEventListener('click', () => {
                if (currentAction && currentAction !== '#') {
                    window.open(currentAction, '_blank');
                }
                popup.style.display = 'none';
            });
        }

        if (popupCancel) {
            popupCancel.addEventListener('click', () => {
                popup.style.display = 'none';
            });
        }

        if (popupClose) {
            popupClose.addEventListener('click', () => {
                popup.style.display = 'none';
            });
        }

        // Close on background click
        if (popup) {
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.style.display = 'none';
                }
            });
        }
    }

    // Show error
    function showError(message) {
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('user-info-panel').style.display = 'none';
        document.getElementById('error-container').style.display = 'flex';
        document.getElementById('error-message').textContent = message;
    }

    // Run on page load
    window.addEventListener('load', handleCallback);
</script>
</body>
</html>
