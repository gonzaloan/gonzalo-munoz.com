<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Welcome Back!</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles.css">
    <style>
        .user-info-panel {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 4px solid #fff;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100;
            max-width: 500px;
            width: 90%;
            color: white;
            font-family: 'Press Start 2P', cursive, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
        }

        .user-info-panel h2 {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .info-section {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 12px;
        }

        .info-label {
            font-weight: bold;
            color: #FFD700;
        }

        .info-value {
            color: #fff;
            text-align: right;
        }

        .api-status {
            text-align: center;
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 12px;
        }

        .api-status.connected {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }

        .api-status.loading {
            background: rgba(255, 193, 7, 0.3);
            border: 2px solid #FFC107;
        }

        .api-status.error {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }

        .logout-btn {
            width: 100%;
            margin-top: 20px;
        }

        .star-icon {
            display: inline-block;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            text-align: center;
            color: white;
        }

        .loading-spinner h2 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        #error-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .error-content {
            max-width: 500px;
        }

        .error-content h2 {
            color: #f44336;
            font-size: 24px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<!-- Loading Container -->
<div id="loading-container" style="display: none;">
    <div class="loading-spinner">
        <div class="loading-logo">
            <div class="mario-jump"></div>
        </div>
        <h2>Authenticating...</h2>
        <p>Please wait while we verify your credentials.</p>
    </div>
</div>

<!-- Error Container -->
<div id="error-container" style="display: none;">
    <div class="error-content">
        <h2>Authentication Error</h2>
        <p id="error-message">Something went wrong. Please try again.</p>
        <button onclick="window.location.href='index.html'" class="snes-button" style="margin-top: 20px;">Back to Home</button>
    </div>
</div>

<!-- Main Game Container -->
<header class="game-header">
    <div class="header-content">
        <div class="header-left">
            <img src="./img/logo.png" alt="Logo" class="header-logo">
        </div>
        <div class="header-right">
            <a href="https://guide.gonzalo-munoz.com" class="snes-button" target="_blank">My Notes!</a>
        </div>
    </div>
</header>

<div id="game-container">
    <div id="mario"></div>
    <div class="coins">
        <div class="coin-icon"></div>
        <span id="coin-count">99</span>
    </div>

    <!-- User Info Panel -->
    <div class="user-info-panel" id="user-info-panel" style="display: none;">
        <h2><span class="star-icon">‚≠ê</span> Welcome Back! <span class="star-icon">‚≠ê</span></h2>

        <div class="info-section">
            <div class="info-row">
                <span class="info-label">Email:</span>
                <span class="info-value" id="user-email">Loading...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Username:</span>
                <span class="info-value" id="user-username">Loading...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Verified:</span>
                <span class="info-value" id="user-verified">Loading...</span>
            </div>
        </div>

        <div class="api-status loading" id="api-status">
            <span>üîÑ Connecting to API...</span>
        </div>

        <button id="logout-button" class="snes-button logout-btn">Logout</button>
    </div>

    <div id="mobile-controls">
        <button id="left-arrow">‚Üê</button>
        <button id="right-arrow">‚Üí</button>
    </div>
</div>

<!-- Audio Elements -->
<audio id="bg-music" loop>
    <source src="./music/mario-ground-theme.mp3" type="audio/mpeg">
</audio>
<audio id="victory-music">
    <source src="./music/mario-castle-complete.mp3" type="audio/mpeg">
</audio>

<script src="auth-config.js"></script>
<script src="api-client.js"></script>
<script src="logged.js"></script>
<script type="module" src="js/main.js"></script>
<script>
    // Handle Cognito callback and exchange code for tokens
    async function handleCallback() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        if (error) {
            showError(`Authentication error: ${error}`);
            return;
        }

        if (!code) {
            // Check if already logged in
            const idToken = sessionStorage.getItem('idToken');
            if (idToken && isTokenValid(idToken)) {
                displayUserInfo();
                return;
            }
            showError('No authentication code found. Please login again.');
            return;
        }

        // Show loading
        document.getElementById('loading-container').style.display = 'flex';

        try {
            // Exchange code for tokens
            const tokens = await exchangeCodeForTokens(code);

            // Store tokens in sessionStorage
            sessionStorage.setItem('idToken', tokens.id_token);
            sessionStorage.setItem('accessToken', tokens.access_token);
            sessionStorage.setItem('refreshToken', tokens.refresh_token);

            // Clean URL (remove code parameter)
            window.history.replaceState({}, document.title, window.location.pathname);

            // Display user info
            displayUserInfo();
        } catch (err) {
            console.error('Token exchange failed:', err);
            showError('Failed to authenticate. Please try again.');
        }
    }

    // Exchange authorization code for tokens
    async function exchangeCodeForTokens(code) {
        const tokenEndpoint = `${COGNITO_CONFIG.domain}/oauth2/token`;

        const params = new URLSearchParams({
            grant_type: 'authorization_code',
            client_id: COGNITO_CONFIG.clientId,
            code: code,
            redirect_uri: getRedirectUri()
        });

        const response = await fetch(tokenEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: params.toString()
        });

        if (!response.ok) {
            throw new Error('Token exchange failed');
        }

        return await response.json();
    }

    // Check if token is valid (not expired)
    function isTokenValid(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const exp = payload.exp * 1000; // Convert to milliseconds
            return Date.now() < exp;
        } catch (e) {
            return false;
        }
    }

    // Decode JWT and get user info from token
    function getUserInfoFromToken(idToken) {
        try {
            const payload = JSON.parse(atob(idToken.split('.')[1]));
            return {
                email: payload.email || payload['cognito:username'] || 'User',
                username: payload['cognito:username'] || payload.email || 'User',
                emailVerified: payload.email_verified || false,
                sub: payload.sub
            };
        } catch (e) {
            return { email: 'User', username: 'User', emailVerified: false };
        }
    }

    // Load user info from API
    async function loadApiUserInfo() {
        const statusDiv = document.getElementById('api-status');

        try {
            const apiUserInfo = await getUserInfo();

            if (apiUserInfo && apiUserInfo.user) {
                statusDiv.className = 'api-status connected';
                statusDiv.innerHTML = '<span>API Connected!</span>';
            } else {
                statusDiv.className = 'api-status error';
                statusDiv.innerHTML = '<span>API responded but no data</span>';
            }
        } catch (error) {
            console.error('Failed to load API user info:', error);
            statusDiv.className = 'api-status error';

            // Show CORS error hint for localhost
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                statusDiv.innerHTML = '<span>CORS: Use production URL</span>';
            } else {
                statusDiv.innerHTML = '<span>API Connection Failed</span>';
            }
        }
    }

    // Display user info
    function displayUserInfo() {
        const idToken = sessionStorage.getItem('idToken');

        if (!idToken) {
            showError('No valid session found. Please login again.');
            return;
        }

        const userInfo = getUserInfoFromToken(idToken);

        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('user-info-panel').style.display = 'block';
        document.getElementById('user-email').textContent = userInfo.email;
        document.getElementById('user-username').textContent = userInfo.username;
        document.getElementById('user-verified').textContent = userInfo.emailVerified ? '‚úÖ Yes' : '‚ùå No';

        // Setup logout button
        document.getElementById('logout-button').addEventListener('click', logout);

        // Load user info from API
        loadApiUserInfo();

        // Initialize the Logged class for animations
        new Logged();
    }

    // Show error
    function showError(message) {
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('user-info-panel').style.display = 'none';
        document.getElementById('error-container').style.display = 'flex';
        document.getElementById('error-message').textContent = message;
    }

    // Run on page load
    window.addEventListener('load', handleCallback);
</script>
</body>
</html>
